{% extends "base.html" %}

{% block content %}
<style>
    .custom-select {
        color: black;
        background-color: white;
    }
    .custom-select option {
        color: black;
    }
</style>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montar Sprint da Semana</title>
    <script>


            // Inicializar a variável empresasTokens no localStorage
            const empresasTokens = [
            {
                nome: "Sette7",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205278753339325',
                team: '1205278753339327'
            },
            {
                nome: "ES360",
                token: 'Bearer 1/1150237826145564:8aa093214a72b8a8c73eff3cb5a777ac',
                workspace: '16363265495050',
                team: '1205288598041717'
              },
              {
                nome: "Bizarte",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205346334659692',
                team: '1205346334659694'
              },
              {
                nome: "Fabricio Noronha",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205378427861979',
                team: '1205378427861981'
              },
              {
                nome: "Colégio Mopi",
                token: 'Bearer 1/1205316107728184:00826bd0b7f0b5d590b98eebdd07d2ad',
                workspace: '1205380996045685',
                team: '1205380996045687'
              },
              {
                nome: "Acontece Portal de Noticias",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205385688547984',
                team: '1205385688547986'
              },
              {
                nome: "Rafael Wolak",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205407478863640',
                team: '1205407478863642'
              },
              {
                nome: "Ciclo Organico",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205427390711884',
                team: '1205427390711886'
              },
              {
                nome: "Raul Oliveira",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205479312230476',
                team: '1205479312230478'
              },
              {
                nome: "Big Big Material de Construção",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205499842562298',
                team: '1205499842562300'
              },
              {
                nome: "Vila Recreio",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205540470200318',
                team: '1205540470200320'
              }]



        function updateSquads() {
            const empresaId = document.getElementById('empresa_id').value;
            fetch('/get_squads_sprint/' + empresaId)
                .then(response => response.json())
                .then(data => {
                    const squadDropdown = document.getElementById('squad_id');
                    squadDropdown.innerHTML = "";
                    data.forEach(squad => {
                        const option = document.createElement('option');
                        option.value = squad.id;
                        option.innerText = squad.nome;
                        squadDropdown.appendChild(option);
                    });
                });
        }

       async function fetchAsanaKRs() {
        console.log("entrou")

            const empresaId = await fetchEmpresaId();
            console.log(empresaId)
            let response = await fetch(`/get_empresa_name?id=${empresaId}`);
            let data = await response.json();

            if (data.error) {
                console.error(data.error);
                return;
            }

            const selectedEmpresaNome = data.nome;
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaSelected = empresasTokens.find(empresa => empresa.nome === selectedEmpresaNome);
            console.log(empresaSelected)

            if (!empresaSelected) {
                console.log("empresaSelected não encontrado");
                return;
            }

            const selectedSquadId = document.getElementById('squad_id').value;
            console.log(selectedSquadId)
            const squadResponse = await fetch(`/get_squad_name?empresa_id=${empresaId}&squad_id=${selectedSquadId}`);
            const squadData = await squadResponse.json();

            if (squadData.error) {
                console.error(squadData.error);
                return;
            }

            const selectedSquadName = squadData.squad_name;
            const workSette = empresaSelected.workspace;
            const allKRs = [];
            let updatedCount = 0;

            async function getKRIdByName(name) {
                const response = await fetch('/get_kr_id?name=' + encodeURIComponent(name));
                const data = await response.json();
                return data.success ? data.kr_id : null;
            }

            const projectsResponse = await fetch(`https://app.asana.com/api/1.0/workspaces/${workSette}/projects?archived=false`, {
                method: 'GET',
                headers: {
                    'Authorization': empresaSelected.token,
                    'Accept': 'application/json'
                }
            });

            const projectsData = await projectsResponse.json();
            console.log(projectsData)
            const project = projectsData.data.find(p => p.name === selectedSquadName);

            if (project) {
                const projectId = project.gid;
                const sectionsResponse = await fetch(`https://app.asana.com/api/1.0/projects/${projectId}/sections`, {
                    method: 'GET',
                    headers: {
                        'Authorization': empresaSelected.token,
                        'Accept': 'application/json'
                    }
                });

                const sectionsData = await sectionsResponse.json();
                const krSection = sectionsData.data.find(section => section.name === "KR");

                if (krSection) {
                    const tasksResponse = await fetch(`https://app.asana.com/api/1.0/sections/${krSection.gid}/tasks`, {
                        method: 'GET',
                        headers: {
                            'Authorization': empresaSelected.token,
                            'Accept': 'application/json'
                        }
                    });

                    const tasksData = await tasksResponse.json();
                    for (const task of tasksData.data) {
                        const taskDetailResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': empresaSelected.token,
                                'Accept': 'application/json'
                            }
                        });

                        const taskDetailData = await taskDetailResponse.json();
                        const subtasksResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}/subtasks`, {
                            method: 'GET',
                            headers: {
                                'Authorization': empresaSelected.token,
                                'Accept': 'application/json'
                            }
                        });

                        const subtasksData = await subtasksResponse.json();
                        const krId = await getKRIdByName(taskDetailData.data.name);
                        if (krId) {
                            allKRs.push({
                                id: krId,
                                empresa: empresaSelected.nome,
                                subtarefas: subtasksData.data.map(subtask => subtask.name),
                                squad_name: project.name,
                                squad_id: selectedSquadId,
                                tarefa: taskDetailData.data.name,
                                descricao: taskDetailData.data.notes
                            });
                        }
                    }
                }
            }

            for (const kr of allKRs) {
                const response = await fetch('/cadastrar_metas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(kr)
                });

                const data = await response.json();
                if (data.success) {
                    updatedCount++;
                }
            }
            console.log("Total de KRs atualizados:", updatedCount);
        }


        async function fetchKanbaTasks(boardID) {
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);

            const headers = {
                'Content-Type': 'application/json',
                'apikey': empresaObj ? empresaObj.token : ''
            };

            const colunas = await getColunas(boardID);
            const colunaTarefasEmAndamento = colunas.data.find(coluna => coluna.name === "Tarefas em andamento");

            if (!colunaTarefasEmAndamento) return;

            const response = await fetch(`http://localhost:3000/proxy/cards`, { headers: headers });
            const data = await response.json();

            if (data.error) return;

            const cards = data.data.data.filter(card => card.board_id === boardID && card.column_id === colunaTarefasEmAndamento.column_id);

            function stripHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || "";
            }

            for (let card of cards) {
                const subtasksResponse = await fetch(`http://localhost:3000/proxy/cards_desc/${card.card_id}`, { headers: headers });
                const subtasksData = await subtasksResponse.json();
                card.subtasks = subtasksData.data.subtasks || [];

                for (let subtask of card.subtasks) {
                    subtask.description = stripHtml(subtask.description);
                }
            }

            return cards;
        }

        async function fetchKanbaTasksConcluidas(boardID) {
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);

            const headers = {
                'Content-Type': 'application/json',
                'apikey': empresaObj ? empresaObj.token : ''
            };

            const colunas = await getColunas(boardID);
            console.log(colunas)
            const colunaTarefasConcluidas = colunas.data.find(coluna => coluna.name === "Tarefas concluídas");

            if (!colunaTarefasConcluidas) return [];

            const response = await fetch(`http://localhost:3000/proxy/cards`, { headers: headers });
            const data = await response.json();

            if (data.error || !data.data || !Array.isArray(data.data.data)) return [];

            const cards = data.data.data.filter(card => card.board_id === boardID && card.column_id === colunaTarefasConcluidas.column_id);

            function stripHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || "";
            }

            for (let card of cards) {
                const subtasksResponse = await fetch(`http://localhost:3000/proxy/cards_desc/${card.card_id}`, { headers: headers });
                const subtasksData = await subtasksResponse.json();
                card.subtasks = subtasksData.data.subtasks || [];

                for (let subtask of card.subtasks) {
                    subtask.description = stripHtml(subtask.description);
                }
            }

            return cards;
        }

        async function fetchKanbaTasksAndCompare() {
            const empresaName = localStorage.getItem('empresaName');
            const squadName = localStorage.getItem('squadName');

            const boardID = await getBoards();
            const asanaTasks = await fetchKanbaTasks(boardID);
            console.log(asanaTasks)
            const asanaConcluidas = await fetchKanbaTasksConcluidas(boardID);
            const dbTasks = await fetchTarefasAtuais();
            const dbTasksConc = await fetchTarefasFinalizadas();

            await registerTasksInDatabaseKanba(asanaTasks);
            console.log(asanaConcluidas)
            await registerTasksInDatabaseConcluidosKanba(asanaConcluidas);

            const asanaTaskNames = asanaTasks.map(task => task.title.toLowerCase().trim());
            const tasksToDelete = dbTasks.filter(dbTask => !asanaTaskNames.includes(dbTask.nome_tarefa.toLowerCase().trim()) && dbTask.nome_empresa === empresaName && dbTask.nome_squad === squadName);
            for (const task of tasksToDelete) {
                const deletionResult = await deleteTarefa(task.id);
                console.log("Tarefa deletada!")

            }

            const asanaTaskNamesConc = asanaConcluidas.map(task => task.title.toLowerCase().trim());
            console.log(asanaTaskNamesConc)
            const tasksToDeleteConc = dbTasksConc.filter(dbTasksConc => !asanaTaskNamesConc.includes(dbTasksConc.nome_tarefa.toLowerCase().trim()) && dbTasksConc.nome_empresa === empresaName && dbTasksConc.nome_squad === squadName);
            console.log(tasksToDeleteConc)
            for (const task of tasksToDeleteConc) {
                const deletionResult = await deleteTarefaConcluidos(task.id);
                console.log("Tarefa deletada!")
            }
        }

        async function getColunas(boardID) {
            console.log("Board:" + boardID)
            const proxyUrl = `http://localhost:3000/proxy/boards/${boardID}/columns`;
            const nomeEmpresaKanba = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(empresa => empresa.nome === nomeEmpresaKanba);
            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return [];
            }
            const empresaToken = empresaObj.token;

            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': empresaToken
                }
            });

            if (!response.ok) {
                console.error("Erro ao obter colunas:", await response.text());
                return [];
            }

            return await response.json();
        }


        async function runAsanaFunctions(event) {
            event.preventDefault();
            document.querySelector('form').submit();
            window.addEventListener('load', () => {
                updateSquads();
            });
        }

        async function fetchAsanaTasksAndCompare() {
            empresaName = localStorage.getItem('empresaName');
            squadName = localStorage.getItem('squadName');
            const asanaTasks = await fetchAsanaTasks();
            const asanaConcluidas = await fetchAsanaTasksConcluidas();
            const dbTasks = await fetchTarefasAtuais();
            console.log(dbTasks)
            const dbTasksConc = await fetchTarefasFinalizadas();

            await registerTasksInDatabase(asanaTasks);
            await registerTasksInDatabaseConcluidos(asanaConcluidas);

            const asanaTaskNames = asanaTasks.map(task => task.tarefa);
            console.log(asanaTaskNames)

            const tasksToDelete = dbTasks.filter(dbTask => !asanaTaskNames.includes(dbTask.nome_tarefa) && dbTask.nome_empresa === empresaName && dbTask.nome_squad === squadName);
            console.log(tasksToDelete)
            for (const task of tasksToDelete) {
                const deletionResult = await deleteTarefa(task.id);
            }

            const asanaTaskNamesConc = asanaConcluidas.map(task => task.tarefa);
            const tasksToDeleteConc = dbTasksConc.filter(dbTasksConc => !asanaTaskNamesConc.includes(dbTasksConc.nome_tarefa) && dbTasksConc.nome_empresa === empresaName && dbTasksConc.nome_squad === squadName);
            for (const task of tasksToDeleteConc) {
                const deletionResultConc = await deleteTarefaConcluidos(task.id);
            }
        }


        async function registerTasksInDatabase(tasks) {
            console.log(tasks)
            for (let task of tasks) {
                const verificaExistencia = await fetch('/verificar_tarefa_existente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tarefa: task })
                });

                const verificaResposta = await verificaExistencia.json();


                if (verificaResposta.existe) {
                    continue;
                }

                const response = await fetch('/cadastrar_tarefas_atuais_new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tarefas: [task] })
                });

                const responseData = await response.json();

                console.log('Resultado da chamada /cadastrar_tarefas_atuais para tarefa:', task, responseData);

                if (!responseData.success) {
                    console.error(`Erro ao adicionar tarefa: ${responseData.error}`);
                }
            }

        }

        async function registerTasksInDatabaseKanba(tasks) {
            const empresaName = localStorage.getItem('empresaName');
            const squadName = localStorage.getItem('squadName');

            console.log("Tasks recebidas:", tasks);

            for (let task of tasks) {
                console.log("Processando task:", task.title);

                const verificaExistencia = await fetch('/verificar_tarefa_existente_kanba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tarefa: task.title,
                        empresa: empresaName,
                        squad_name: squadName
                    })
                });

                const verificaResposta = await verificaExistencia.json();

                console.log("Resposta da verificação:", verificaResposta);

                if (verificaResposta.existe) {
                    console.log("Tarefa já existe, pulando:", task.title);
                    continue;
                }

                const subtasksDescriptions = task.subtasks.map(subtask => subtask.description);

                console.log("Subtarefas processadas:", subtasksDescriptions);

                const response = await fetch('/cadastrar_tarefas_atuais_kanba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tarefas: [{
                            title: task.title,
                            subtarefas: subtasksDescriptions
                        }],
                        empresa: empresaName,
                        squad_name: squadName
                    })
                });

                const responseData = await response.json();

                console.log("Resposta do cadastro:", responseData);

                if (!responseData.success) {
                    console.error(`Erro ao adicionar tarefa: ${responseData.error}`);
                }
            }
        }

        async function registerTasksInDatabaseConcluidosKanba(tasks) {
            if (!Array.isArray(tasks)) return;

            const empresaName = localStorage.getItem('empresaName');
            const squadName = localStorage.getItem('squadName');

            for (let task of tasks) {
                const verificaExistencia = await fetch('/verificar_tarefa_existente_concluidas_kanba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tarefa: task.title,
                        empresa: empresaName,
                        squad_name: squadName
                    })
                });

                const verificaResposta = await verificaExistencia.json();

                if (verificaResposta.existe) {
                    continue;
                }

                const subtasksDescriptions = task.subtasks.map(subtask => subtask.description);

                const response = await fetch('/cadastrar_tarefas_concluidas_kanba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tarefas: [{
                            title: task.title,
                            subtarefas: subtasksDescriptions
                        }],
                        empresa: empresaName,
                        squad_name: squadName
                    })
                });

                const responseData = await response.json();

                if (!responseData.success) {
                    console.error(`Erro ao adicionar tarefa: ${responseData.error}`);
                }
            }
        }


        async function fetchAsanaTasks() {
            const plataforma = localStorage.getItem('plataformaAsana');
            console.log("Plataforma:", plataforma);

            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            console.log("Empresas Tokens:", empresasTokens);

            const allTasks = [];
            const empresaId = await fetchEmpresaId();
            console.log("Empresa ID:", empresaId);

            const squadId = await fetchSquadId();
            console.log("Squad ID:", squadId);

            const responseEmpresaName = await fetch(`/get_empresa_name?id=${empresaId}`);
            const empresaNameData = await responseEmpresaName.json();
            const nomeEmpresa = empresaNameData.nome;
            console.log("Nome Empresa:", nomeEmpresa);

            async function getSquadId(squadName, empresaName) {
                const response = await fetch('/get_squad_id?squad_name=' + encodeURIComponent(squadName) + '&empresa_name=' + encodeURIComponent(empresaName));
                const data = await response.json();
                console.log("Data from getSquadId:", data);
                return data.success ? data.squad_id : null;
            }

            const empresa = empresasTokens.find(e => e.nome === nomeEmpresa);
            console.log(empresa)
            if (empresa) {
                const projectsResponse = await fetch(`https://app.asana.com/api/1.0/workspaces/${empresa.workspace}/projects?archived=false`, {
                    method: 'GET',
                    headers: {
                        'Authorization': empresa.token,
                        'Accept': 'application/json'
                    }
                });
                const projectsData = await projectsResponse.json();
                console.log(projectsData)
                projectsGid = projectsData.data[0].gid
                projectsName = projectsData.data[0].name
                console.log(projectsName)

                if (projectsGid) {

                    const sectionsResponse = await fetch(`https://app.asana.com/api/1.0/projects/${projectsGid}/sections`, {
                        method: 'GET',
                        headers: {
                            'Authorization': empresa.token,
                            'Accept': 'application/json'
                        }
                    });
                    const sectionsData = await sectionsResponse.json();
                    console.log("Sections Data:", sectionsData);

                    const completedTasksSection = sectionsData.data.find(section => section.name === "Tarefas em andamento");
                    console.log("Completed Tasks Section:", completedTasksSection);

                    if (completedTasksSection) {

                        const tasksResponse = await fetch(`https://app.asana.com/api/1.0/sections/${completedTasksSection.gid}/tasks`, {
                            method: 'GET',
                            headers: {
                                'Authorization': empresa.token,
                                'Accept': 'application/json'
                            }
                        });
                        const tasksData = await tasksResponse.json();
                        console.log("Tasks Data:", tasksData);

                        for (const task of tasksData.data) {
                            const taskDetailResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': empresa.token,
                                    'Accept': 'application/json'
                                }
                            });
                            const taskDetailData = await taskDetailResponse.json();
                            console.log("Task Detail Data:", taskDetailData);

                            const subtasksResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}/subtasks`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': empresa.token,
                                    'Accept': 'application/json'
                                }
                            });
                            const subtasksData = await subtasksResponse.json();
                            console.log("Subtasks Data:", subtasksData);

                            const squadIdFromFunction = await getSquadId(projectsName, empresa.nome);
                            console.log("Squad ID from Function:", squadIdFromFunction);

                            if (squadIdFromFunction) {
                                allTasks.push({
                                    empresa: empresa.nome,
                                    subtarefas: subtasksData.data.map(subtask => subtask.name),
                                    squad_name: projectsName,
                                    squad_id: squadIdFromFunction,
                                    tarefa: taskDetailData.data.name
                                });
                            }
                        }
                    }
                }
            }

            console.log("All tasks:", allTasks);
            return allTasks;
        }



        async function fetchAsanaTasksConcluidas() {
            const plataforma = localStorage.getItem('plataformaAsana');
            console.log("Plataforma:", plataforma);

            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            console.log("Empresas Tokens:", empresasTokens);

            const allTasks = [];
            const empresaId = await fetchEmpresaId();
            console.log("Empresa ID:", empresaId);

            const squadId = await fetchSquadId();
            console.log("Squad ID:", squadId);

            const responseEmpresaName = await fetch(`/get_empresa_name?id=${empresaId}`);
            const empresaNameData = await responseEmpresaName.json();
            const nomeEmpresa = empresaNameData.nome;
            console.log("Nome Empresa:", nomeEmpresa);

            async function getSquadId(squadName, empresaName) {
                const response = await fetch('/get_squad_id?squad_name=' + encodeURIComponent(squadName) + '&empresa_name=' + encodeURIComponent(empresaName));
                const data = await response.json();
                console.log("Data from getSquadId:", data);
                return data.success ? data.squad_id : null;
            }

            const empresa = empresasTokens.find(e => e.nome === nomeEmpresa);
            console.log(empresa)
            if (empresa) {
                const projectsResponse = await fetch(`https://app.asana.com/api/1.0/workspaces/${empresa.workspace}/projects?archived=false`, {
                    method: 'GET',
                    headers: {
                        'Authorization': empresa.token,
                        'Accept': 'application/json'
                    }
                });
                const projectsData = await projectsResponse.json();
                projectsGid = projectsData.data[0].gid
                projectsName = projectsData.data[0].name
                console.log(projectsName)

                if (projectsGid) {

                    const sectionsResponse = await fetch(`https://app.asana.com/api/1.0/projects/${projectsGid}/sections`, {
                        method: 'GET',
                        headers: {
                            'Authorization': empresa.token,
                            'Accept': 'application/json'
                        }
                    });
                    const sectionsData = await sectionsResponse.json();
                    console.log("Sections Data:", sectionsData);

                    const completedTasksSection = sectionsData.data.find(section => section.name === "Tarefas concluídas");
                    console.log("Completed Tasks Section:", completedTasksSection);

                    if (completedTasksSection) {

                        const tasksResponse = await fetch(`https://app.asana.com/api/1.0/sections/${completedTasksSection.gid}/tasks`, {
                            method: 'GET',
                            headers: {
                                'Authorization': empresa.token,
                                'Accept': 'application/json'
                            }
                        });
                        const tasksData = await tasksResponse.json();
                        console.log("Tasks Data:", tasksData);

                        for (const task of tasksData.data) {
                            const taskDetailResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': empresa.token,
                                    'Accept': 'application/json'
                                }
                            });
                            const taskDetailData = await taskDetailResponse.json();
                            console.log("Task Detail Data:", taskDetailData);

                            const subtasksResponse = await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}/subtasks`, {
                                method: 'GET',
                                headers: {
                                    'Authorization': empresa.token,
                                    'Accept': 'application/json'
                                }
                            });
                            const subtasksData = await subtasksResponse.json();
                            console.log("Subtasks Data:", subtasksData);

                            const squadIdFromFunction = await getSquadId(projectsName, empresa.nome);
                            console.log("Squad ID from Function:", squadIdFromFunction);

                            if (squadIdFromFunction) {
                                allTasks.push({
                                    empresa: empresa.nome,
                                    subtarefas: subtasksData.data.map(subtask => subtask.name),
                                    squad_name: projectsName,
                                    squad_id: squadIdFromFunction,
                                    tarefa: taskDetailData.data.name
                                });
                            }
                        }
                    }
                }
            }

            console.log("All tasks:", allTasks);
            return allTasks;
        }


        async function registerTasksInDatabaseConcluidos(tasks) {
            for (let task of tasks) {
                const verificaExistencia = await fetch('/verificar_tarefa_concluida_existente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tarefa: task })
                });
                const verificaResposta = await verificaExistencia.json();
                if (verificaResposta.existe) {
                    continue;
                }

                const response = await fetch('/cadastrar_tarefas_concluidas_new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tarefas: [task] })
                });
                const responseData = await response.json();
                if (!responseData.success) {
                    console.error(`Erro ao adicionar tarefa: ${responseData.error}`);
                }
            }
        }


        async function fetchTarefasAtuais() {
            const empresaName = localStorage.getItem('empresaName');
            const squadName = localStorage.getItem('squadName');
            const response = await fetch('/get_tarefas_atuais', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    empresaName: empresaName,
                    squadName: squadName
                })
            });
            return response.json();
        }


        async function fetchTarefasFinalizadas() {
            const empresaName = localStorage.getItem('empresaName');
            const squadName = localStorage.getItem('squadName');
            const response = await fetch('/get_tarefas_concluidas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    empresaName: empresaName,
                    squadName: squadName
                })
            });
            return response.json();
        }

        async function deleteTarefa(id) {
            const url = '/deletar_tarefa/' + id;
            const response = await fetch(url, { method: 'POST' });
            return response.ok;
        }

        async function deleteTarefaConcluidos(id) {
            const url = '/deletar_tarefa_concluida/' + id;
            const response = await fetch(url, { method: 'POST' });
            return response.ok;
        }

        function salvarDadosNoLocalStorage() {
            const empresaDropdown = document.getElementById('empresa_id');
            const squadDropdown = document.getElementById('squad_id');
            const empresaName = empresaDropdown.options[empresaDropdown.selectedIndex].text;
            const squadName = squadDropdown.options[squadDropdown.selectedIndex].text;

            localStorage.setItem('empresaName', empresaName);
            localStorage.setItem('squadName', squadName);
        }



        async function fetchEmpresaId() {
            const empresaName = localStorage.getItem('empresaName');

            try {
                const response = await fetch(`/get_empresaId?empresa_name=${encodeURIComponent(empresaName)}`);
                const data = await response.json();
                console.log(data)
                if (data.success) {
                    return data.empresa_id;
                } else {
                    console.error('Erro ao obter empresa_id:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Erro ao fazer a requisição:', error);
                return null;
            }
        }

        async function fetchSquadId() {
            const squadName = localStorage.getItem('squadName');
            const empresaName = localStorage.getItem('empresaName');

            try {
                const response = await fetch(`/get_squad_id?squad_name=${encodeURIComponent(squadName)}&empresa_name=${encodeURIComponent(empresaName)}`);
                const data = await response.json();
                if (data.success) {
                    return data.squad_id;
                } else {
                    console.error('Erro ao obter squad_id:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Erro ao fazer a requisição:', error);
                return null;
            }
        }

        async function deleteAsanaTasksFromSection() {
            const squadName = localStorage.getItem('squadName');
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));

            const empresa = empresasTokens.find(e => e.nome === empresaName);
            if (!empresa) {
                console.error(`Token para a empresa ${empresaName} não encontrado.`);
                return;
            }

            const projectsResponse = await fetch(`https://app.asana.com/api/1.0/workspaces/${empresa.workspace}/projects`, {
                headers: {
                    'Authorization': empresa.token
                }
            });

            const projectsData = await projectsResponse.json();
            console.log(projectsData)
            const project = projectsData.data.find(p => p.name === squadName);
            if (!project) {
                console.error(`Projeto para a empresa ${empresaName} não encontrado.`);
                return;
            }

            const projectID = project.gid;

            const sectionsResponse = await fetch(`https://app.asana.com/api/1.0/projects/${projectID}/sections`, {
                method: 'GET',
                headers: {
                    'Authorization': empresa.token,
                    'Accept': 'application/json'
                }
            });

            const sectionsData = await sectionsResponse.json();
            const metasSection = sectionsData.data.find(section => section.name === "Meta semanal e Tarefas");
            if (metasSection) {
                const tasksResponse = await fetch(`https://app.asana.com/api/1.0/sections/${metasSection.gid}/tasks`, {
                    method: 'GET',
                    headers: {
                        'Authorization': empresa.token,
                        'Accept': 'application/json'
                    }
                });

                const tasksData = await tasksResponse.json();
                for (const task of tasksData.data) {
                    await fetch(`https://app.asana.com/api/1.0/tasks/${task.gid}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': empresa.token,
                            'Accept': 'application/json'
                        }
                    });
                }
            }

        }




        async function getSections(projectID) {
            const url = `https://app.asana.com/api/1.0/projects/${projectID}/sections`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3'
                }
            });
            const data = await response.json();
            return data.data;
        }

        window.onload = function() {
            // Inicializar a variável empresasTokens no localStorage
            const empresasTokens = [
            {
                nome: "Sette7",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205278753339325',
                team: '1205278753339327'
            },
            {
                nome: "ES360",
                token: 'Bearer 1/1150237826145564:8aa093214a72b8a8c73eff3cb5a777ac',
                workspace: '16363265495050',
                team: '1205288598041717'
              },
              {
                nome: "Bizarte",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205346334659692',
                team: '1205346334659694'
              },
              {
                nome: "Fabricio Noronha",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205378427861979',
                team: '1205378427861981'
              },
              {
                nome: "Colégio Mopi",
                token: 'Bearer 1/1205316107728184:00826bd0b7f0b5d590b98eebdd07d2ad',
                workspace: '1205380996045685',
                team: '1205380996045687'
              },
              {
                nome: "Acontece Portal de Noticias",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205385688547984',
                team: '1205385688547986'
              },
              {
                nome: "Rafael Wolak",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205407478863640',
                team: '1205407478863642'
              },
              {
                nome: "Ciclo Organico",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205427390711884',
                team: '1205427390711886'
              },
              {
                nome: "Raul Oliveira",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205479312230476',
                team: '1205479312230478'
              },
              {
                nome: "Big Big Material de Construção",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205499842562298',
                team: '1205499842562300'
              },
              {
                nome: "Vila Recreio",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205540470200318',
                team: '1205540470200320'
              },
              {
                nome: "Planeta Sublimação",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205619173673240',
                team: '1205619173673242'
              },
              {
                nome: "Espaço Pontal",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205634578408157',
                team: '1205634578408159'
              },
              {
                nome: "Rafael Oliveira",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205684136448505',
                team: '1205634578408159'
              },
              {
                nome: "Vivian Coser",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205695317101693',
                team: '1205695317101695'
              },

              {
                nome: "TRC TEAC Co.",
                token: '3zm3y2udvUvZQT8kvKv6mWItHtZcfxbcpDF121cr',
                workspace: '1205540470200318',
                team: '1205540470200320'
              }]
            localStorage.setItem('empresasTokens', JSON.stringify(empresasTokens));
        };


        async function executeTasksInOrder() {

            const metasData = await gerarTarefasEMetas();
            const metas = metasData && metasData.data ? metasData.data : [];

            if (metas && metas.length) {
                console.log(metas);
                await registerMetasInDatabase(metas);
                await deleteAsanaTasksFromSection()
                await createTasksFromTable(metas);
            } else {
                alert("Erro ao gerar as tarefas!")
                console.error('No metas data returned from gerarTarefasEMetas.');
            }

        }

        async function getBoards() {
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);
            console.log(empresaObj)

            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return null;
            }

            const proxyUrl = `http://localhost:3000/proxy/boards`;
            try {
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': empresaObj.token
                    }
                });

                // Verificar se a resposta foi bem-sucedida
                if (!response.ok) {
                    console.error(`Erro na requisição: ${response.status} - ${response.statusText}`);
                    const textResponse = await response.text();
                    console.error(`Resposta completa: ${textResponse}`);
                    return null;
                }

                const data = await response.json();
                console.log("Data recebida:", data);

                const squadName = localStorage.getItem('squadName');
                console.log(squadName)
                const board = data.data.find(board => board.name === squadName);
                console.log("BAODSA: " + board)
                return board ? board.board_id : null;
            } catch (error) {
                console.error("Erro ao obter boards:", error);
                return null;
            }
        }

        async function deleteTasksKanba(boardID) {
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);

            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return;
            }

            const colunas = await getColunas(boardID);
            const colunaTarefasEmAndamento = colunas.data.find(coluna => coluna.name === "Meta semanal e Tarefas");

            if (!colunaTarefasEmAndamento) {
                console.error("Coluna 'Meta semanal e Tarefas' não encontrada.");
                return;
            }

            const cardsResponse = await fetch(`http://localhost:3000/proxy/cards`, {
                method: 'GET',
                headers: {
                    'apikey': empresaObj.token
                }
            });
            const allCards = await cardsResponse.json();

            const cardsToDelete = allCards.data.data.filter(card => card.board_id === boardID && card.column_id === colunaTarefasEmAndamento.column_id);

            for (const card of cardsToDelete) {
                await fetch(`http://localhost:3000/proxy/delete_cards/${card.card_id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': empresaObj.token
                    }
                });
            }
        }

        async function fetchKRsKanba(boardID) {
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);

            const headers = {
                'Content-Type': 'application/json',
                'apikey': empresaObj ? empresaObj.token : ''
            };

            const colunas = await getColunas(boardID);
            const colunaKR = colunas.data.find(coluna => coluna.name === "KR");

            if (!colunaKR) return;

            const response = await fetch(`http://localhost:3000/proxy/cards`, { headers: headers });
            const data = await response.json();

            if (data.error) return;

            const cards = data.data.data.filter(card => card.board_id === boardID && card.column_id === colunaKR.column_id);

            function stripHtml(html) {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                return doc.body.textContent || "";
            }

            async function getKRIdByName(name) {
                const response = await fetch('/get_kr_id?name=' + encodeURIComponent(name));
                const data = await response.json();
                return data.success ? data.kr_id : null;
            }

            for (let card of cards) {
                const subtasksResponse = await fetch(`http://localhost:3000/proxy/cards_desc/${card.card_id}`, { headers: headers });
                const subtasksData = await subtasksResponse.json();
                card.description = stripHtml(subtasksData.data.description);

                if (card.description.trim() === "") {
                    card.description = "";
                }

                const krID = await getKRIdByName(card.title);
                if (krID) {
                    await fetch('/cadastrar_metas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            id: krID,
                            descricao: card.description
                        })
                    });
                }
            }
        }


        async function executeTasksInOrderKanba() {
            const boardID = await getBoards();

            if (!boardID) {
                console.error("Board ID não encontrado.");
                return;
            }

            const metasData = await gerarTarefasEMetas();
            const metas = metasData && metasData.data ? metasData.data : [];

            if (metas && metas.length) {
                await registerMetasInDatabase(metas);
                await deleteTasksKanba(boardID);
                await createTasksFromTableKanba(boardID, metas);
            } else {
                alert("Erro ao gerar as tarefas!")
                console.error('No metas data returned from gerarTarefasEMetas.');
            }
        }

        async function createTasksFromTableKanba(boardID, metas) {
            console.log(metas)
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(e => e.nome === empresaName);

            const workflow_id = await getWorkflow(boardID);
            console.log("Workflow: " + workflow_id)
            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return;
            }

            const colunas = await getColunas(boardID);
            const colunaTarefasEmAndamento = colunas.data.find(coluna => coluna.name === "Meta semanal e Tarefas");
            console.log(colunaTarefasEmAndamento)

            if (!colunaTarefasEmAndamento) {
                console.error("Coluna 'Tarefas em andamento' não encontrada.");
                return;
            }

            for (const meta of metas) {
                const proxyUrl = `http://localhost:3000/createOKRTasks`;
                const data = {
                    "board_id": boardID,
                    "title": meta.tarefa,
                    "column_id": colunaTarefasEmAndamento.column_id,
                    "lane_id": workflow_id + 1,
                    "description":meta.meta_semanal
                };

                try {
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': empresaObj.token
                        },
                        body: JSON.stringify(data)
                    });
                } catch (error) {
                    console.error("Erro ao criar tarefa:", error);
                }
            }
        }


        async function getWorkflow(boardID) {
            console.log(boardID)
            const proxyUrl = `http://localhost:3000/proxy/boards/${boardID}/workflows`;
            const nomeEmpresaKanba = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));
            const empresaObj = empresasTokens.find(empresa => empresa.nome === nomeEmpresaKanba);
            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return null;
            }
            const empresaToken = empresaObj.token;

            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': empresaToken
                }
            });

            if (!response.ok) {
                console.error("Erro ao obter workflows:", await response.text());
                return null;
            }

            const responseData = await response.json();
            const workflow = responseData.data.find(w => w.name === "Cards workflow");
            return workflow ? workflow.workflow_id : null;
        }

        async function registerMetasInDatabase(metas) {
            try {
                const response = await fetch('/register_metas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metas)
                });
                if (!response.ok) {
                    throw new Error('Failed to register metas in database');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function gerarTarefasEMetas() {
            const empresaId = await fetchEmpresaId();
            const squadId = await fetchSquadId();

            if (!squadId || !empresaId) {
                console.error('Não foi possível obter o Squad ID ou Empresa ID');
                return null;
            }

            const data = {
                'empresa_id': empresaId,
                'squad_id': squadId
            };

            try {
                const response = await fetch('/gerar_tarefas_metas_semanais_novo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log('Status da resposta:', response.status);

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('Dados da resposta:', responseData);
                    return responseData;
                } else {
                    const responseText = await response.text();
                    console.error('Erro ao gerar tarefas e metas semanais:', responseText);
                    return null;
                }
            } catch (error) {
                console.error('Erro ao fazer a chamada fetch:', error);
                return null;
            }
        }




        async function fetchTarefasByEmpresaAndSquad(empresaName, squadName) {
            const response = await fetch(`/listar_tarefas?empresa=${empresaName}&squad_name=${squadName}`);
            if (response.ok) {
                console.log(response)
                return await response.json();
            } else {
                console.error("Erro ao buscar tarefas.");
                return [];
            }
        }


        async function createTasksFromTable(metas) {
            const squadName = localStorage.getItem('squadName');
            const empresaName = localStorage.getItem('empresaName');
            const empresasTokens = JSON.parse(localStorage.getItem('empresasTokens'));

            const empresa = empresasTokens.find(e => e.nome === empresaName);
            if (!empresa) {
                console.error(`Token para a empresa ${empresaName} não encontrado.`);
                return;
            }

            const projectsResponse = await fetch(`https://app.asana.com/api/1.0/workspaces/${empresa.workspace}/projects`, {
                headers: {
                    'Authorization': empresa.token
                }
            });

            const projectsData = await projectsResponse.json();
            console.log(projectsData)
            const project = projectsData.data.find(p => p.name === squadName);
            if (!project) {
                console.error(`Projeto para a empresa ${empresaName} não encontrado.`);
                return;
            }

            const projectID = project.gid;
            const sections = await getSections(projectID);
            const targetSection = sections.find(section => section.name === "Meta semanal e Tarefas");

            for (const task of metas) {
                const url = "https://app.asana.com/api/1.0/tasks";
                const data = {
                    "data": {
                        "name": task.tarefa,
                        "notes": task.meta_semanal,
                        "projects": [projectID]
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': empresa.token
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                if (responseData.data && responseData.data.gid) {
                    const taskID = responseData.data.gid;
                    const moveUrl = `https://app.asana.com/api/1.0/sections/${targetSection.gid}/addTask`;
                    const moveData = {
                        "data": {
                            "task": taskID
                        }
                    };

                    await fetch(moveUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': empresa.token
                        },
                        body: JSON.stringify(moveData)
                    });

                    console.log(`Tarefa '${task.tarefa}' inserida no Asana com sucesso.`);
                }
            }
        }

        async function getSections(projectID) {
            const empresaNome = localStorage.getItem('empresaSelecionada');
            const empresaObj = empresasTokens.find(e => e.nome === empresaNome);

            if (!empresaObj) {
                console.error("Empresa não encontrada no array empresasTokens.");
                return [];
            }

            const url = `https://app.asana.com/api/1.0/projects/${projectID}/sections`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': empresaObj.token
                }
            });
            const data = await response.json();
            return data.data;
        }



        function salvarEmpresa() {
            const empresaSelect = document.getElementById('empresa_id');
            const empresaNome = empresaSelect.options[empresaSelect.selectedIndex].text;

            localStorage.setItem('empresaSelecionada', empresaNome);
        }

        async function executeFunctions(event) {
            const empresasTokens = [
            {
                nome: "Sette7",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205278753339325',
                team: '1205278753339327'
            },
            {
                nome: "ES360",
                token: 'Bearer 1/1150237826145564:8aa093214a72b8a8c73eff3cb5a777ac',
                workspace: '16363265495050',
                team: '1205288598041717'
              },
              {
                nome: "Bizarte",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205346334659692',
                team: '1205346334659694'
              },
              {
                nome: "Fabricio Noronha",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205378427861979',
                team: '1205378427861981'
              },
              {
                nome: "Colégio Mopi",
                token: 'Bearer 1/1205316107728184:00826bd0b7f0b5d590b98eebdd07d2ad',
                workspace: '1205380996045685',
                team: '1205380996045687'
              },
              {
                nome: "Acontece Portal de Noticias",
                token: 'Bearer 1/1202777718375879:371b46e1e900b0e9d5f88933929c6770',
                workspace: '1205385688547984',
                team: '1205385688547986'
              },
              {
                nome: "Rafael Wolak",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205407478863640',
                team: '1205407478863642'
              },
              {
                nome: "Ciclo Organico",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205427390711884',
                team: '1205427390711886'
              },
              {
                nome: "Raul Oliveira",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205479312230476',
                team: '1205479312230478'
              },
              {
                nome: "Big Big Material de Construção",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205499842562298',
                team: '1205499842562300'
              },
              {
                nome: "Vila Recreio",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205540470200318',
                team: '1205540470200320'
              },
              {
                nome: "Planeta Sublimação",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205619173673240',
                team: '1205619173673242'
              },
              {
                nome: "Espaço Pontal",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205634578408157',
                team: '1205634578408159'
              },
              {
                nome: "Rafael Oliveira",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205684136448505',
                team: '1205634578408159'
              },
              {
                nome: "Vivian Coser",
                token: 'Bearer 1/1205186190607018:e6e9bff4bf54b04e712d5ab8a248d8e3',
                workspace: '1205695317101693',
                team: '1205695317101695'
              },
              {
                nome: "TRC TEAC Co.",
                token: '3zm3y2udvUvZQT8kvKv6mWItHtZcfxbcpDF121cr',
                workspace: '1205540470200318',
                team: '1205540470200320'
              }]

              localStorage.setItem('empresasTokens', JSON.stringify(empresasTokens));

            event.preventDefault();
            const boardID = await getBoards();
            console.log("boardzinho: " + boardID)


            const empresaName = localStorage.getItem('empresaName');
            salvarDadosNoLocalStorage();
            if (empresaName !== "TRC TEAC Co.") {
                console.log("NÃO É TRC")
                await fetchAsanaKRs();
                await fetchAsanaTasksAndCompare();
            }
            else{
                console.log("TRC")

                await fetchKRsKanba(boardID);

                await fetchKanbaTasksAndCompare();
            }


            runAsanaFunctions(event);
        }


    </script>
</head>

<body onload="updateSquads();">
    <h2>Montar Sprint da Semana</h2>
    <form action="/montar_sprint_semana" method="post" onsubmit="executeFunctions(event);">

        <div>
            <label for="empresa_id">Selecione a Empresa:</label>
            <select name="empresa_id" id="empresa_id" onchange="updateSquads()">
                {% for empresa in empresas %}
                <option value="{{ empresa.id }}">{{ empresa.nome_contato }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="squad_id">Selecione o Squad:</label>
            <select name="squad_id" id="squad_id"></select>
        </div>
        <input type="submit" onclick="salvarEmpresa()" value="Selecionar">
    </form>
    <section>
        <h3>FormsObjetivos</h3>
        <ul>
            {% for obj in forms_objetivos %}
            <li>ID: {{ obj.id }} - Data: {{ obj.data }}</li>
            {% endfor %}
        </ul>
    </section>
    <section>
        <h3>OKRs</h3>
        <ul>
            {% for okr in okrs %}
            <li>ID: {{ okr.id }} - Objetivo: {{ okr.objetivo }} - Data Início: {{ okr.data_inicio }} - Data Fim: {{ okr.data_fim }}</li>
            {% endfor %}
        </ul>
    </section>
    <section>
        <h3>KRs</h3>
        <ul>
            {% for kr in krs %}
            <li>ID: {{ kr.id }} - Texto: {{ kr.texto }} - Meta: {{ kr.meta }} - Data Inclusão: {{ kr.data_inclusao }}</li>
            {% endfor %}
        </ul>
    </section>
    <section>
        <h3>MacroAcoes</h3>
        <ul>
            {% for ma in macroacoes %}
            <li>ID: {{ ma.id }} - Texto: {{ ma.texto }} - Data Inclusão: {{ ma.data_inclusao }}</li>
            {% endfor %}
        </ul>
    </section>
    <section>
        <h3>Tarefas Em Andamento</h3>
        <ul>
            {% for tarefa in tarefas_andamento %}
            <li>ID: {{ tarefa.id }} - Tarefa: {{ tarefa.tarefa }} - Data Inclusão: {{ tarefa.data_inclusao }}
                <ul>
                    {% set subtarefas_list = tarefa.subtarefas|tojson|safe %}
                    {% for subtarefa in tarefa.subtarefas %}
                    <li>Subtarefa: {{ subtarefa }}</li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
        </ul>
    </section>
    <section>
        <h3>Tarefas Finalizadas</h3>
        <ul>
            {% for tarefa in tarefas_finalizadas %}
            <li>Tarefa: {{ tarefa.tarefa }} - Data Inclusão: {{ tarefa.data_inclusao }} - Data Conclusão: {{ tarefa.data_conclusao }}
                <ul>
                    {% for subtarefa in tarefa.subtarefas %}
                    <li>Subtarefa: {{ subtarefa }}</li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
        </ul>
    </section>
    <button onclick="handleExecuteTasks()">OK</button>

    <script>
        function handleExecuteTasks() {
            const empresaName = localStorage.getItem('empresaName');
            if (empresaName === "TRC TEAC Co.") {
                console.log("trc")

                executeTasksInOrderKanba();
            } else {
                console.log("não é")
                executeTasksInOrder();
            }
        }
    </script>
</body>
</html>
{% endblock %}